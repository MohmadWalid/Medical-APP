<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Profile - MediScan</title>
    <link rel="stylesheet" href="/static/css/styles.css">
    <link rel="stylesheet" href="/static/css/navigation.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    
    <script>
        // Initialize Firebase with config
        const firebaseConfig = {
            apiKey: "{{ firebase_config.apiKey }}",
            authDomain: "{{ firebase_config.authDomain }}",
            projectId: "{{ firebase_config.projectId }}",
            storageBucket: "{{ firebase_config.storageBucket }}",
            messagingSenderId: "{{ firebase_config.messagingSenderId }}",
            appId: "{{ firebase_config.appId }}",
            measurementId: "{{ firebase_config.measurementId }}"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
    </script>
    
    <style>
        .profile-container {
            max-width: 800px;
            margin: 40px auto;
            padding: 0 24px;
        }

        .profile-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .profile-header h1 {
            font-size: 32px;
            color: #1a202c;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        .profile-header p {
            color: #64748b;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .profile-form {
            background: #ffffff;
            padding: 32px;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(66, 133, 244, 0.08);
        }

        .form-group {
            margin-bottom: 24px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #1a202c;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 15px;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #4285f4;
            box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.1);
        }

        .form-group textarea {
            min-height: 120px;
            resize: vertical;
        }

        .profile-actions {
            margin-top: 32px;
            text-align: right;
        }

        .profile-actions button {
            background: #4285f4;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .profile-actions button:hover {
            background: #3367d6;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(66, 133, 244, 0.2);
        }

        .doctor-fields {
            display: none;
        }

        .doctor-fields.active {
            display: block;
        }

        .profile-preview {
            margin-top: 32px;
            background: #ffffff;
            padding: 32px;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(66, 133, 244, 0.08);
        }

        .profile-preview h3 {
            color: #1a202c;
            margin-bottom: 24px;
            font-size: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .preview-item {
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 1px solid #e2e8f0;
        }

        .preview-item:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }

        .preview-item strong {
            display: block;
            color: #1a202c;
            margin-bottom: 4px;
            font-size: 14px;
        }

        .preview-item span {
            color: #64748b;
            font-size: 15px;
        }

        @media (max-width: 768px) {
            .profile-container {
                margin: 24px auto;
                padding: 0 16px;
            }

            .profile-form,
            .profile-preview {
                padding: 24px;
            }

            .profile-header {
                margin-bottom: 32px;
            }

            .profile-header h1 {
                font-size: 28px;
            }
        }

        /* Navigation Animation Styles */
        .navbar-menu {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .nav-link {
            position: relative;
            color: #64748b;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 8px;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .nav-link::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 50%;
            width: 0;
            height: 2px;
            background: #4285f4;
            transition: all 0.3s ease;
            transform: translateX(-50%);
        }

        .nav-link:hover {
            color: #4285f4;
            background: rgba(66, 133, 244, 0.1);
        }

        .nav-link:hover::after {
            width: 80%;
        }

        .nav-link.active {
            color: #4285f4;
            background: rgba(66, 133, 244, 0.1);
        }

        .nav-link.active::after {
            width: 80%;
        }

        /* Page Transition Animations */
        .main-content {
            animation: fadeIn 0.5s ease;
        }

        .profile-container {
            animation: slideUp 0.5s ease;
        }

        .profile-form {
            animation: slideIn 0.5s ease;
        }

        .profile-preview {
            animation: slideIn 0.5s ease 0.2s backwards;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes slideIn {
            from {
                transform: translateX(-20px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Form Field Animations */
        .form-group {
            transition: all 0.3s ease;
        }

        .form-group:focus-within {
            transform: translateX(5px);
        }

        .form-group input:focus,
        .form-group textarea:focus {
            transform: scale(1.01);
        }

        /* Button Animation */
        .profile-actions button {
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .profile-actions button::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.6s ease, height 0.6s ease;
        }

        .profile-actions button:hover::before {
            width: 300px;
            height: 300px;
        }

        /* Preview Item Animations */
        .preview-item {
            transition: all 0.3s ease;
        }

        .preview-item:hover {
            transform: translateX(5px);
            background: rgba(66, 133, 244, 0.05);
            border-radius: 8px;
            padding-left: 20px;
        }

        /* Loading Animation */
        .loading {
            display: inline-block;
            position: relative;
            width: 80px;
            height: 80px;
        }

        .loading:after {
            content: " ";
            display: block;
            border-radius: 50%;
            width: 0;
            height: 0;
            margin: 8px;
            box-sizing: border-box;
            border: 32px solid #4285f4;
            border-color: #4285f4 transparent #4285f4 transparent;
            animation: loading 1.2s infinite;
        }

        @keyframes loading {
            0% {
                transform: rotate(0);
                animation-timing-function: cubic-bezier(0.55, 0.055, 0.675, 0.19);
            }
            50% {
                transform: rotate(180deg);
                animation-timing-function: cubic-bezier(0.215, 0.61, 0.355, 1);
            }
            100% {
                transform: rotate(360deg);
            }
        }

        /* Notification Animation */
        .notification {
            animation: slideDown 0.5s ease, fadeOut 0.5s ease 4.5s forwards;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
            }
            to {
                opacity: 0;
            }
        }

        /* Page Transition Effects */
        .page-transition {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #ffffff;
            z-index: 9999;
            transform: translateY(100%);
            transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .page-transition.active {
            transform: translateY(0);
        }

        .page-content {
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.5s ease, transform 0.5s ease;
        }

        .page-content.active {
            opacity: 1;
            transform: translateY(0);
        }

        /* Navigation Transition */
        .nav-link {
            position: relative;
            overflow: hidden;
        }

        .nav-link::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(66, 133, 244, 0.1);
            transform: translateX(-100%);
            transition: transform 0.3s ease;
        }

        .nav-link:hover::before {
            transform: translateX(0);
        }

        .nav-link.active::before {
            transform: translateX(0);
            background: rgba(66, 133, 244, 0.2);
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="navbar-container">
            <a href="/" class="navbar-logo">MediScan</a>
            <div class="navbar-toggle">
                <i class="fas fa-bars"></i>
            </div>
            <ul class="navbar-menu" id="navbar-menu">
                <!-- Navigation items will be dynamically populated based on user role -->
            </ul>
        </div>
    </nav>

    <main class="main-content">
        <div class="profile-container">
            <div class="profile-header">
                <h1><i class="fas fa-user-circle"></i> Your Profile</h1>
                <p><i class="fas fa-info-circle"></i> Manage your personal and professional information</p>
            </div>
            
            <form id="profile-form" class="profile-form">
                <div class="form-group">
                    <label for="name"><i class="fas fa-user"></i> Full Name</label>
                    <input type="text" id="name" name="name" placeholder="Enter your full name" required>
                </div>
                
                <div class="form-group">
                    <label for="email"><i class="fas fa-envelope"></i> Email</label>
                    <input type="email" id="email" name="email" readonly>
                </div>

                <div class="doctor-fields">
                    <div class="form-group">
                        <label for="specialization"><i class="fas fa-stethoscope"></i> Specialization</label>
                        <input type="text" id="specialization" name="specialization" placeholder="Enter your medical specialization">
                    </div>
                    
                    <div class="form-group">
                        <label for="license"><i class="fas fa-id-card"></i> Medical License Number</label>
                        <input type="text" id="license" name="license" placeholder="Enter your medical license number">
                    </div>

                    <div class="form-group">
                        <label for="experience"><i class="fas fa-briefcase"></i> Years of Experience</label>
                        <input type="number" id="experience" name="experience" min="0" placeholder="Enter years of experience">
                    </div>

                    <div class="form-group">
                        <label for="qualifications"><i class="fas fa-graduation-cap"></i> Qualifications</label>
                        <textarea id="qualifications" name="qualifications" placeholder="Enter your medical qualifications (one per line)"></textarea>
                        <small><i class="fas fa-info-circle"></i> List each qualification on a new line</small>
                    </div>
                </div>
                
                <div class="profile-actions">
                    <button type="submit"><i class="fas fa-save"></i> Save Profile</button>
                </div>
            </form>
            
            <div class="profile-preview">
                <h3><i class="fas fa-eye"></i> Profile Preview</h3>
                <div id="profile-preview-content">
                    <p>Your profile information will appear here after saving.</p>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Check if user is authenticated and get their role
        firebase.auth().onAuthStateChanged(function(user) {
            if (user) {
                const db = firebase.firestore();
                const navbarMenu = document.getElementById('navbar-menu');
                
                // Check if user is a doctor
                db.collection('doctors').doc(user.uid).get()
                    .then((doc) => {
                        if (doc.exists) {
                            // User is a doctor - show doctor navigation
                            navbarMenu.innerHTML = `
                                <li><a href="/doctor" class="nav-link">Doctor Dashboard</a></li>
                                <li class="active"><a href="/profile" class="nav-link">My Profile</a></li>
                                <li><button id="logout-btn" class="logout-btn">Logout</button></li>
                            `;
                            loadDoctorProfile(user.uid);
                        } else {
                            // User is a patient - show patient navigation
                            navbarMenu.innerHTML = `
                                <li><a href="/dashboard" class="nav-link">Dashboard</a></li>
                                <li><a href="/upload" class="nav-link">Upload Images</a></li>
                                <li><a href="/reports" class="nav-link">My Reports</a></li>
                                <li><a href="/chat" class="nav-link">Medical Chatbot</a></li>
                                <li class="active"><a href="/profile" class="nav-link">My Profile</a></li>
                                <li><button id="logout-btn" class="logout-btn">Logout</button></li>
                            `;
                            loadPatientProfile(user.uid);
                        }
                    })
                    .catch((error) => {
                        console.error("Error checking user role:", error);
                    });
            } else {
                window.location.href = '/login';
            }
        });

        function loadDoctorProfile(userId) {
            const db = firebase.firestore();
            const emailInput = document.getElementById('email');
            
            // Set email
            firebase.auth().currentUser.email;
            
            // Load doctor profile
            db.collection('doctors').doc(userId).get()
                .then((doc) => {
                    if (doc.exists) {
                        const data = doc.data();
                        document.getElementById('name').value = data.name || '';
                        document.getElementById('specialization').value = data.specialization || '';
                        document.getElementById('license').value = data.license || '';
                        document.getElementById('experience').value = data.experience || '';
                        document.getElementById('qualifications').value = data.qualifications || '';
                        
                        // Update preview
                        updateDoctorPreview(data);
                    }
                })
                .catch((error) => {
                    console.error("Error loading doctor profile:", error);
                });
        }

        function loadPatientProfile(userId) {
            const db = firebase.firestore();
            const emailInput = document.getElementById('email');
            
            // Set email
            emailInput.value = firebase.auth().currentUser.email;
            
            // Load patient profile
            db.collection('patients').doc(userId).get()
                .then((doc) => {
                    if (doc.exists) {
                        const data = doc.data();
                        document.getElementById('name').value = data.name || '';
                        
                        // Update preview
                        updatePatientPreview(data);
                    }
                })
                .catch((error) => {
                    console.error("Error loading patient profile:", error);
                });
        }

        function updateDoctorPreview(data) {
            const previewContent = document.getElementById('profile-preview-content');
            previewContent.innerHTML = `
                <div class="preview-item">
                    <strong>Full Name</strong>
                    <span>${data.name || 'Not set'}</span>
                </div>
                <div class="preview-item">
                    <strong>Email</strong>
                    <span>${firebase.auth().currentUser.email}</span>
                </div>
                <div class="preview-item">
                    <strong>Specialization</strong>
                    <span>${data.specialization || 'Not set'}</span>
                </div>
                <div class="preview-item">
                    <strong>Medical License</strong>
                    <span>${data.license || 'Not set'}</span>
                </div>
                <div class="preview-item">
                    <strong>Experience</strong>
                    <span>${data.experience ? data.experience + ' years' : 'Not set'}</span>
                </div>
                <div class="preview-item">
                    <strong>Qualifications</strong>
                    <span>${data.qualifications || 'Not set'}</span>
                </div>
            `;
        }

        function updatePatientPreview(data) {
            const previewContent = document.getElementById('profile-preview-content');
            previewContent.innerHTML = `
                <div class="preview-item">
                    <strong>Full Name</strong>
                    <span>${data.name || 'Not set'}</span>
                </div>
                <div class="preview-item">
                    <strong>Email</strong>
                    <span>${firebase.auth().currentUser.email}</span>
                </div>
            `;
        }

        // Handle form submission
        document.getElementById('profile-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const user = firebase.auth().currentUser;
            if (!user) {
                window.location.href = '/login';
                return;
            }

            const db = firebase.firestore();
            const formData = {
                name: document.getElementById('name').value,
                email: user.email
            };

            // Check if user is a doctor
            db.collection('doctors').doc(user.uid).get()
                .then((doc) => {
                    if (doc.exists) {
                        // Add doctor-specific fields
                        formData.specialization = document.getElementById('specialization').value;
                        formData.license = document.getElementById('license').value;
                        formData.experience = document.getElementById('experience').value;
                        formData.qualifications = document.getElementById('qualifications').value;
                        
                        // Update doctor profile
                        return db.collection('doctors').doc(user.uid).update(formData);
                    } else {
                        // Update patient profile
                        return db.collection('patients').doc(user.uid).update(formData);
                    }
                })
                .then(() => {
                    alert('Profile updated successfully!');
                    // Reload profile
                    if (formData.specialization) {
                        updateDoctorPreview(formData);
                    } else {
                        updatePatientPreview(formData);
                    }
                })
                .catch((error) => {
                    console.error("Error updating profile:", error);
                    alert('Error updating profile. Please try again.');
                });
        });

        // Add logout functionality
        document.getElementById('logout-btn').addEventListener('click', function() {
            firebase.auth().signOut().then(() => {
                window.location.href = '/login';
            }).catch((error) => {
                console.error('Error signing out:', error);
            });
        });

        // Add page transition handling
        document.addEventListener('DOMContentLoaded', function() {
            // Create transition overlay
            const transitionOverlay = document.createElement('div');
            transitionOverlay.className = 'page-transition';
            document.body.appendChild(transitionOverlay);

            // Add active class to page content
            const pageContent = document.querySelector('.main-content');
            if (pageContent) {
                pageContent.classList.add('page-content');
                setTimeout(() => {
                    pageContent.classList.add('active');
                }, 100);
            }

            // Handle navigation clicks
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    if (!this.classList.contains('active')) {
                        e.preventDefault();
                        const href = this.getAttribute('href');
                        
                        // Start exit animation
                        if (pageContent) {
                            pageContent.classList.remove('active');
                        }
                        transitionOverlay.classList.add('active');
                        
                        // Navigate after animation
                        setTimeout(() => {
                            window.location.href = href;
                        }, 500);
                    }
                });
            });

            // Handle page load
            window.addEventListener('pageshow', function(event) {
                if (event.persisted) {
                    // Page is loaded from cache
                    if (pageContent) {
                        pageContent.classList.add('active');
                    }
                    transitionOverlay.classList.remove('active');
                }
            });

            // Initialize transition on page load
            if (pageContent) {
                pageContent.classList.add('active');
            }
            transitionOverlay.classList.remove('active');
        });

        // Enhanced notification function
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.style.display = 'block';
            
            // Remove existing animation classes
            notification.classList.remove('slideDown', 'fadeOut');
            
            // Force reflow
            void notification.offsetWidth;
            
            // Add animation classes
            notification.classList.add('slideDown');
            
            setTimeout(() => {
                notification.classList.add('fadeOut');
                setTimeout(() => {
                    notification.style.display = 'none';
                }, 500);
            }, 4000);
        }

        // Add smooth scroll behavior
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                }
            });
        });

        // Add form field animations
        document.querySelectorAll('.form-group input, .form-group textarea').forEach(field => {
            field.addEventListener('focus', function() {
                this.parentElement.classList.add('focused');
            });
            
            field.addEventListener('blur', function() {
                this.parentElement.classList.remove('focused');
            });
        });
    </script>
</body>
</html>